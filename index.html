<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地下室工程造價概算系統 v56.9.3 - 全域備份版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .method-tab-active { background-color: #4338ca; color: white; transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .region-tab-active { border-color: #4338ca; background-color: #eef2ff; color: #4338ca; font-weight: 900; }
        .modal-bg { background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .physics-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .physics-card:hover { transform: translateY(-2px); border-color: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-start justify-between mb-8 gap-6 border-b pb-8 border-slate-200">
            <div class="space-y-3">
                <div class="flex items-center gap-2 text-indigo-600 font-black text-xs tracking-widest uppercase">
                    <span class="bg-indigo-600 text-white px-2 py-0.5 rounded">PRO</span> Version 56.9.3
                </div>
                <h1 class="text-3xl font-black text-slate-800 flex items-center gap-3">
                    <i data-lucide="building-2" class="text-indigo-700 w-8 h-8"></i>
                    地下室工程造價概算系統
                </h1>
                <div class="flex flex-wrap gap-3 text-[10px] font-black">
                    <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-slate-200 text-slate-500 shadow-sm">
                        <i data-lucide="user" class="text-indigo-500 w-3 h-3"></i> UID: <span id="uid-display" class="font-mono">OFFLINE</span>
                    </div>
                    <!-- 強化後的匯出按鈕 -->
                    <button onclick="exportAllData()" class="flex items-center gap-2 bg-emerald-600 text-white px-4 py-1.5 rounded-full shadow-sm hover:bg-emerald-700 transition-all">
                        <i data-lucide="download" class="w-3 h-3"></i> 匯出完整備份 (XLSX)
                    </button>
                    <!-- 強化後的匯入按鈕 -->
                    <label class="flex items-center gap-2 bg-amber-500 text-white px-4 py-1.5 rounded-full shadow-sm hover:bg-amber-600 transition-all cursor-pointer">
                        <i data-lucide="upload" class="w-3 h-3"></i> 匯入完整備份
                        <input type="file" id="import-excel" class="hidden" accept=".xlsx, .xls" onchange="importAllData(event)">
                    </label>
                </div>
            </div>
            <div class="text-right bg-white p-6 rounded-3xl border border-slate-200 shadow-xl min-w-[280px]">
                <p class="text-[10px] text-slate-400 font-black uppercase tracking-wider mb-1">工程總造價預估 (未稅)</p>
                <p id="total-budget" class="text-4xl font-black text-indigo-700 leading-none tracking-tighter mb-3">0元</p>
                <div class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded-lg inline-flex items-center gap-2">
                    <span class="text-[10px] font-black uppercase">平均單坪:</span>
                    <span id="avg-cost" class="text-sm font-black">0元</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- 左側輸入 -->
            <section class="lg:col-span-5 space-y-6">
                <!-- 區域選擇與管理 -->
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                    <div class="bg-indigo-700 p-5 flex items-center justify-between text-white">
                        <div class="flex items-center gap-3">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            <h3 class="text-sm font-black uppercase tracking-widest">區域單價庫</h3>
                        </div>
                        <button onclick="openRegionModal()" class="bg-white/20 hover:bg-white/30 p-1.5 rounded-lg transition-colors">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <div id="region-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- 規模工法 -->
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                    <div class="bg-slate-900 p-5 flex items-center gap-3 text-white">
                        <i data-lucide="settings" class="w-5 h-5 text-indigo-400"></i>
                        <h3 class="text-sm font-black uppercase">1. 規模與基本設定</h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase text-slate-400">擋土工法選擇</label>
                            <div class="flex bg-slate-100 p-1 rounded-xl gap-1">
                                <button onclick="updateState('retainingMethod', 'wall')" id="btn-method-wall" class="flex-1 py-2 text-xs font-black rounded-lg transition-all">連續壁</button>
                                <button onclick="updateState('retainingMethod', 'pile')" id="btn-method-pile" class="flex-1 py-2 text-xs font-black rounded-lg transition-all">排樁</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-5">
                            <div class="input-group" data-label="地下單層面積" data-unit="坪" data-key="belowUnitArea"></div>
                            <div class="input-group" data-label="地下總層數" data-unit="層" data-key="belowFloors"></div>
                        </div>
                        <div class="input-group" data-label="地下建築週長" data-unit="m" data-key="belowPerimeter"></div>
                    </div>
                </div>

                <!-- 結構用量參數 -->
                <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                    <div class="bg-emerald-600 p-5 flex items-center gap-3 text-white">
                        <i data-lucide="layout-grid" class="w-5 h-5"></i>
                        <h3 class="text-sm font-black uppercase">2. 分層結構用量 (m²)</h3>
                    </div>
                    <div class="p-6 space-y-6">
                        <div class="space-y-3">
                            <div class="flex items-center gap-2"><span class="bg-emerald-100 text-emerald-700 text-[10px] font-black px-2 py-0.5 rounded">Raft</span><span class="text-xs font-black text-slate-500">筏基層用量 (每 m²)</span></div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="input-group-region" data-label="RC" data-unit="m³" data-key="unitRC_Raft"></div>
                                <div class="input-group-region" data-label="模板" data-unit="m²" data-key="unitForm_Raft"></div>
                                <div class="input-group-region" data-label="鋼筋" data-unit="kg" data-key="unitRebar_Raft"></div>
                            </div>
                        </div>
                        <div class="space-y-3 pt-4 border-t border-slate-100">
                            <div class="flex items-center gap-2"><span class="bg-blue-100 text-blue-700 text-[10px] font-black px-2 py-0.5 rounded">B1</span><span class="text-xs font-black text-slate-500">B1層用量 (每 m²)</span></div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="input-group-region" data-label="RC" data-unit="m³" data-key="unitRC_B1"></div>
                                <div class="input-group-region" data-label="模板" data-unit="m²" data-key="unitForm_B1"></div>
                                <div class="input-group-region" data-label="鋼筋" data-unit="kg" data-key="unitRebar_B1"></div>
                            </div>
                        </div>
                        <div class="space-y-3 pt-4 border-t border-slate-100">
                            <div class="flex items-center gap-2"><span class="bg-slate-200 text-slate-700 text-[10px] font-black px-2 py-0.5 rounded">Typical</span><span class="text-xs font-black text-slate-500">標準層用量 (每 m²)</span></div>
                            <div class="grid grid-cols-3 gap-3">
                                <div class="input-group-region" data-label="RC" data-unit="m³" data-key="unitRC_Typ"></div>
                                <div class="input-group-region" data-label="模板" data-unit="m²" data-key="unitForm_Typ"></div>
                                <div class="input-group-region" data-label="鋼筋" data-unit="kg" data-key="unitRebar_Typ"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 右側報表 -->
            <section class="lg:col-span-7 space-y-6">
                <!-- 整合指標卡 -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4" id="physics-cards"></div>

                <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase border-b">
                            <tr><th class="px-8 py-4">預算大項</th><th class="px-8 py-4 text-right">概算金額</th></tr>
                        </thead>
                        <tbody id="budget-body" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>

                <!-- 單價細項編輯 -->
                <div class="bg-slate-900 text-white p-8 rounded-[40px] shadow-2xl space-y-10">
                    <div class="border-b border-slate-800 pb-6 flex items-center justify-between">
                        <div>
                            <h4 class="text-xl font-black text-indigo-400">區域細項單價設定</h4>
                            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mt-1">目前區域：<span id="current-region-label" class="text-white tracking-normal">載入中</span></p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editRegionName()" class="p-2 bg-slate-800 hover:bg-slate-700 rounded-xl transition-all" title="重新命名">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteCurrentRegion()" class="p-2 bg-rose-900/50 hover:bg-rose-800 text-rose-400 rounded-xl transition-all" title="刪除區域">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-10">
                        <div id="wall-rates-group" class="space-y-4">
                            <h5 class="text-[10px] font-black text-indigo-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="layers" class="w-3 h-3"></i> 擋土工程細項</h5>
                            <div id="wall-rates-list" class="space-y-3"></div>
                        </div>
                        <div class="space-y-4">
                            <h5 class="text-[10px] font-black text-rose-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="anchor" class="w-3 h-3"></i> 支撐與構台參數</h5>
                            <div id="support-rates-list" class="space-y-3"></div>
                        </div>
                        <div class="space-y-4 md:col-span-2 border-t border-slate-800 pt-6">
                            <h5 class="text-[10px] font-black text-emerald-400 uppercase tracking-widest flex items-center gap-2"><i data-lucide="box" class="w-3 h-3"></i> 結構材單價與雜項</h5>
                            <div id="other-rates-list" class="grid grid-cols-2 md:grid-cols-3 gap-x-8 gap-y-3"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- 彈窗: 新增區域 -->
    <div id="region-modal" class="fixed inset-0 modal-bg z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[32px] w-full max-w-md overflow-hidden shadow-2xl">
            <div class="bg-indigo-700 p-6 text-white flex justify-between items-center">
                <h3 class="font-black text-lg">新增區域</h3>
                <button onclick="closeRegionModal()"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-8 space-y-6">
                <div class="space-y-2">
                    <label class="text-xs font-black text-slate-400 uppercase">區域名稱</label>
                    <input type="text" id="new-region-name" placeholder="例如：台南地區..." class="w-full border-2 border-slate-100 rounded-2xl px-5 py-3 outline-none focus:border-indigo-500 transition-all font-bold">
                </div>
                <button onclick="confirmAddRegion()" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">建立區域</button>
            </div>
        </div>
    </div>

    <!-- 訊息提示 -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-xs font-black shadow-2xl opacity-0 transition-opacity pointer-events-none z-50"></div>

    <script>
        const PING_TO_M2 = 3.3058;
        const DEFAULT_PARAMS = {
            rateWall60: 18500, rateWall70: 20500, rateWall80: 22500, rateWall90: 25000, rateWall100: 27500,
            rateGuideWall: 4500, ratePavement: 1200, rateSettlingTank: 150000, rateWallChip: 1200, rateWallRebarBend: 1500,
            rateCappingBeam: 4500, rateLaggingBoard: 1150, ratePileUnit: 48000,
            rateSupportM2: 850, rateSupportPostRent: 35000, rateSupportPostBuy: 55000, ratePlatformM2: 12000,
            rateMonitoring: 500, rateEarthworkM3: 550, rateBasementMEP: 14000, rateBasementFinish: 6000, 
            rateRC_M3: 3100, ratePC_M3: 2500, rateForm_M2: 950, rateRebar_KG: 32.5,
            depthRatio: 2.0, thicknessRatio: 20, pileSpacing: 1.2, 
            supportHorizontalSpacing: 5.0, supportVerticalSpan: 3.5,
            platformRatio: 0.4, b1HeightCustom: 4.2, typicalHeightCustom: 3.2, raftFoundationCustom: 2.5,
            unitRC_Raft: 1.15, unitForm_Raft: 1.36, unitRebar_Raft: 227,
            unitRC_B1: 0.85, unitForm_B1: 3.18, unitRebar_B1: 157,
            unitRC_Typ: 0.73, unitForm_Typ: 2.96, unitRebar_Typ: 145
        };

        const KEY_LABELS = {
            rateWall60: '60cm壁 (元/m²)', rateWall70: '70cm壁 (元/m²)', rateWall80: '80cm壁 (元/m²)',
            rateWall90: '90cm壁 (元/m²)', rateWall100: '100cm壁 (元/m²)', rateGuideWall: '導溝工程 (元/m)',
            ratePavement: '鋪面工程 (元/m²)', rateSettlingTank: '棄土沉澱池 (元/式)', rateWallChip: '劣質打除 (元/m)', 
            rateWallRebarBend: '預留筋彎出 (元/m)', depthRatio: '連壁深度比 (倍)', thicknessRatio: '連壁厚度比 (1/N)',
            rateCappingBeam: '壓梁工程 (元/m)', rateLaggingBoard: '擋土板工程 (元/m²)', ratePileUnit: '排樁單支 (元)',
            rateSupportM2: '支撐費 (元/m²)', rateSupportPostRent: '中間樁租金 (元/支)', rateSupportPostBuy: '中間樁買斷 (元/支)', 
            ratePlatformM2: '施工構台 (元/m²)', rateMonitoring: '安全觀測 (元/坪)',
            supportHorizontalSpacing: '支撐水平間距 (m)', supportVerticalSpan: '支撐垂直跨距 (m)', platformRatio: '施工構台比例 (0~1)',
            rateEarthworkM3: '土方清運 (元/m³)', rateBasementMEP: '機電 (元/坪)', rateBasementFinish: '裝修 (元/坪)',
            rateRC_M3: '混凝土 (元/m³)', ratePC_M3: 'PC 混凝土 (元/m³)', rateForm_M2: '模板 (元/m²)', rateRebar_KG: '鋼筋 (元/kg)'
        };

        let regions = [
            { id: 'north', name: '雙北區', ...DEFAULT_PARAMS, rateEarthworkM3: 650 },
            { id: 'taoyuan', name: '桃園區', ...DEFAULT_PARAMS, rateEarthworkM3: 580 },
            { id: 'central', name: '台中區', ...DEFAULT_PARAMS, rateEarthworkM3: 500 },
            { id: 'south', name: '南區', ...DEFAULT_PARAMS, rateEarthworkM3: 450 }
        ];

        let state = { retainingMethod: 'wall', belowUnitArea: 150, belowFloors: 3, belowPerimeter: 0, activeRegionId: 'north' };
        let db, auth, appId;

        async function initFirebase() {
            try {
                const configStr = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                if (!configStr) { render(); return; }
                const firebaseConfig = JSON.parse(configStr);
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth(); db = firebase.firestore();
                appId = typeof __app_id !== 'undefined' ? __app_id : 'basement-v56-9';
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
                
                auth.onAuthStateChanged(user => { 
                    if (user) { 
                        document.getElementById('uid-display').innerText = user.uid; 
                        listenToData(user.uid, appId); 
                    } 
                });
            } catch (err) { render(); }
        }

        function listenToData(uid, appId) {
            db.doc(`artifacts/${appId}/users/${uid}/settings/current`).onSnapshot(doc => { 
                if (doc.exists) { state = { ...state, ...doc.data() }; render(); } 
            });
            db.collection(`artifacts/${appId}/users/${uid}/regions`).onSnapshot(snap => {
                if (!snap.empty) { 
                    const loaded = snap.docs.map(d => ({ id: d.id, ...DEFAULT_PARAMS, ...d.data() }));
                    regions = loaded;
                    if (!regions.find(r => r.id === state.activeRegionId)) state.activeRegionId = regions[0].id;
                    render(); 
                } else { 
                    const batch = db.batch(); 
                    regions.forEach(r => batch.set(db.doc(`artifacts/${appId}/users/${uid}/regions/${r.id}`), r)); 
                    batch.commit(); 
                }
            }, err => console.error("Firestore Error:", err));
        }

        async function saveData() { if (auth && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/settings/current`).set(state); }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = '1'; setTimeout(() => t.style.opacity = '0', 3000); }
        function openRegionModal() { document.getElementById('region-modal').classList.remove('hidden'); }
        function closeRegionModal() { document.getElementById('region-modal').classList.add('hidden'); }
        
        async function confirmAddRegion() {
            const name = document.getElementById('new-region-name').value.trim(); if (!name) return;
            const newId = 'reg_' + Date.now(); const newRegion = { ...DEFAULT_PARAMS, id: newId, name: name };
            if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${newId}`).set(newRegion);
            else regions.push(newRegion);
            state.activeRegionId = newId; closeRegionModal(); render(); saveData();
        }

        async function updateRegionParam(key, value) {
            const val = parseFloat(value) || 0; const reg = regions.find(r => r.id === state.activeRegionId); if (!reg) return;
            reg[key] = val; if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${reg.id}`).update({ [key]: val });
            render();
        }

        async function editRegionName() {
            const reg = regions.find(r => r.id === state.activeRegionId); if (!reg) return;
            const newName = prompt("請輸入新的區域名稱：", reg.name);
            if (newName && newName.trim()) {
                reg.name = newName.trim();
                if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${reg.id}`).update({ name: reg.name });
                render();
            }
        }

        async function deleteCurrentRegion() {
            if (regions.length <= 1) { showToast("至少需保留一個區域"); return; }
            if (confirm("確定要刪除此區域嗎？數據將無法恢復。")) {
                const targetId = state.activeRegionId;
                if (db && auth.currentUser) await db.doc(`artifacts/${appId}/users/${auth.currentUser.uid}/regions/${targetId}`).delete();
                regions = regions.filter(r => r.id !== targetId);
                state.activeRegionId = regions[0].id;
                render();
                saveData();
            }
        }

        function updateState(key, value) { state[key] = (typeof value === 'string' && !['wall','pile'].includes(value)) ? parseFloat(value) : value; render(); saveData(); }
        function selectRegion(id) { state.activeRegionId = id; render(); saveData(); }

        /**
         * 強化匯出功能：導出所有區域設定 + 目前系統狀態
         */
        function exportAllData() {
            const wb = XLSX.utils.book_new();
            
            // 1. 系統狀態與計算結果 (摘要頁)
            const { results, total, avg, physics } = calculate();
            const activeReg = regions.find(r => r.id === state.activeRegionId);
            const summaryData = [
                ["地下室工程造價概算報表 - 完整系統備份"],
                ["備份日期", new Date().toLocaleString()],
                [""],
                ["[當前系統規模設定]"],
                ["區域", activeReg.name],
                ["工法", state.retainingMethod === 'wall' ? '連續壁' : '排樁'],
                ["單層面積", state.belowUnitArea, "坪"],
                ["總層數", state.belowFloors, "層"],
                ["週長", state.belowPerimeter || physics.sysPerimeter, "m"],
                [""],
                ["[概算摘要]"],
                ["工程總價 (未稅)", total, "元"],
                ["平均單坪造價", avg, "元/坪"],
                ["開挖深度", physics.excavationDepth.toFixed(2), "m"],
                ["總建築面積", physics.totalBelowBuildArea, "坪"]
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), "系統摘要");

            // 2. 所有區域單價庫 (區域設定頁)
            const regionHeaders = ["id", "name", ...Object.keys(DEFAULT_PARAMS)];
            const regionData = [regionHeaders];
            regions.forEach(r => {
                regionData.push(regionHeaders.map(h => r[h]));
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(regionData), "區域單價庫備份");

            // 3. 系統狀態 JSON (隱藏數據頁，供匯入使用)
            const backupJson = {
                version: "56.9.3",
                state: state,
                regions: regions
            };
            const jsonSheetData = [["BACKUP_DATA"], [JSON.stringify(backupJson)]];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(jsonSheetData), "DATA_DO_NOT_EDIT");

            XLSX.writeFile(wb, `地下室系統完整備份_${new Date().toLocaleDateString()}.xlsx`);
            showToast("完整備份匯出成功");
        }

        /**
         * 強化匯入功能：從隱藏頁面讀取 JSON 並還原所有區域與狀態
         */
        async function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 尋找數據備份頁
                    const dataSheet = workbook.Sheets["DATA_DO_NOT_EDIT"];
                    if (!dataSheet) throw new Error("無效的備份格式：找不到 DATA_DO_NOT_EDIT 分頁");

                    const rawJson = dataSheet["A2"]?.v;
                    if (!rawJson) throw new Error("無效的備份格式：備份數據為空");

                    const backup = JSON.parse(rawJson);
                    
                    // 開始還原
                    if (confirm(`檢測到備份文件，包含 ${backup.regions.length} 個區域。這將覆蓋您目前的所有數據，是否繼續？`)) {
                        state = backup.state;
                        regions = backup.regions;

                        // 如果有 Firebase，同步到雲端
                        if (db && auth.currentUser) {
                            const uid = auth.currentUser.uid;
                            showToast("正在同步到雲端...");
                            
                            // 更新系統狀態
                            await db.doc(`artifacts/${appId}/users/${uid}/settings/current`).set(state);
                            
                            // 批次更新區域 (注意：為了簡化，先不刪除舊的，而是覆蓋現有的)
                            const batch = db.batch();
                            regions.forEach(r => {
                                const ref = db.doc(`artifacts/${appId}/users/${uid}/regions/${r.id}`);
                                batch.set(ref, r);
                            });
                            await batch.commit();
                        }

                        render();
                        showToast("完整備份匯入完成！");
                    }
                } catch (err) {
                    console.error(err);
                    showToast("匯入失敗：" + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = ""; // 重置 input
        }

        function calculate() {
            const activeReg = regions.find(r => r.id === state.activeRegionId) || regions[0];
            const areaM2 = state.belowUnitArea * PING_TO_M2;
            const sysPerimeter = Math.round(Math.sqrt(areaM2) * 4);
            const finalPerimeter = state.belowPerimeter > 0 ? state.belowPerimeter : sysPerimeter;
            const floors = state.belowFloors;
            const totalBelowBuildArea = state.belowUnitArea * floors;

            const b1Height = activeReg.b1HeightCustom;
            const typTotalHeight = Math.max(0, floors - 1) * activeReg.typicalHeightCustom;
            const raftHeight = activeReg.raftFoundationCustom;
            const excavationDepth = b1Height + typTotalHeight + raftHeight;

            let totalRC = 0, totalForm = 0, totalRebar = 0;
            if (floors >= 2) {
                totalRC = (areaM2 * (activeReg.unitRC_Raft + activeReg.unitRC_B1 + (floors - 2) * activeReg.unitRC_Typ));
                totalForm = (areaM2 * (activeReg.unitForm_Raft + activeReg.unitForm_B1 + (floors - 2) * activeReg.unitForm_Typ));
                totalRebar = (areaM2 * (activeReg.unitRebar_Raft + activeReg.unitRebar_B1 + (floors - 2) * activeReg.unitRebar_Typ));
            } else {
                totalRC = areaM2 * activeReg.unitRC_Raft; totalForm = areaM2 * activeReg.unitForm_Raft; totalRebar = areaM2 * activeReg.unitRebar_Raft;
            }

            const isWall = state.retainingMethod === 'wall';
            let retainingCost = 0, wallThickness = 0, pileCount = 0, wallDepth = 0, wallTotalArea = 0;

            if (isWall) {
                wallThickness = Math.max(0.6, Math.round((excavationDepth / activeReg.thicknessRatio) * 10) / 10);
                wallDepth = excavationDepth * activeReg.depthRatio;
                wallTotalArea = finalPerimeter * wallDepth;
                let wallRate = wallThickness >= 1.0 ? activeReg.rateWall100 : wallThickness >= 0.9 ? activeReg.rateWall90 : wallThickness >= 0.8 ? activeReg.rateWall80 : wallThickness >= 0.7 ? activeReg.rateWall70 : activeReg.rateWall60;
                retainingCost = (wallTotalArea * wallRate) + (finalPerimeter * activeReg.rateGuideWall) + (areaM2 * activeReg.ratePavement) + activeReg.rateSettlingTank + (finalPerimeter * activeReg.rateWallChip) + (finalPerimeter * floors * activeReg.rateWallRebarBend);
            } else {
                pileCount = Math.ceil(finalPerimeter / activeReg.pileSpacing);
                wallTotalArea = finalPerimeter * excavationDepth;
                retainingCost = (pileCount * activeReg.ratePileUnit) + (finalPerimeter * activeReg.rateCappingBeam) + (wallTotalArea * activeReg.rateLaggingBoard);
            }

            const earthworkVolume = (areaM2 * excavationDepth) + (isWall ? finalPerimeter * wallThickness : 0);
            const earthworkCost = earthworkVolume * activeReg.rateEarthworkM3;
            const structureCost = (totalRC * activeReg.rateRC_M3) + (totalForm * activeReg.rateForm_M2) + (totalRebar * activeReg.rateRebar_KG) + (areaM2 * 0.1 * activeReg.ratePC_M3);
            
            const supportLayers = excavationDepth > 3.0 ? Math.max(1, Math.ceil((excavationDepth - 2.5) / activeReg.supportVerticalSpan)) : 0;
            const supportPostCount = activeReg.supportHorizontalSpacing > 0 ? Math.ceil(areaM2 / Math.pow(activeReg.supportHorizontalSpacing, 2)) : 0;
            const platformArea = areaM2 * activeReg.platformRatio;
            const supportCost = (areaM2 * supportLayers * activeReg.rateSupportM2) + (supportPostCount * (activeReg.rateSupportPostRent + activeReg.rateSupportPostBuy)) + (platformArea * activeReg.ratePlatformM2) + (totalBelowBuildArea * activeReg.rateMonitoring);
            
            const extraCost = totalBelowBuildArea * (activeReg.rateBasementMEP + activeReg.rateBasementFinish);
            const total = retainingCost + structureCost + supportCost + earthworkCost + extraCost;

            return { physics: { excavationDepth, totalBelowBuildArea, sysPerimeter, totalRC, totalForm, totalRebar, supportLayers, supportPostCount, platformArea, earthworkVolume, pileCount, wallDepth, wallTotalArea, wallThickness }, results: [
                { l: isWall ? "擋土工程 (連續壁)" : "擋土工程 (排樁)", v: retainingCost, color: 'bg-indigo-500' },
                { l: "結構主體工程", v: structureCost, color: 'bg-emerald-500' },
                { l: "安全支撐工程", v: supportCost, color: 'bg-rose-500' },
                { l: "土方清運工程", v: earthworkCost, color: 'bg-amber-500' }
            ], total, avg: totalBelowBuildArea > 0 ? total / totalBelowBuildArea : 0 };
        }

        function render() {
            const { physics, results, total, avg } = calculate();
            const numFmt = new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 });
            const isWall = state.retainingMethod === 'wall';

            document.getElementById('region-list').innerHTML = regions.map(r => `<button onclick="selectRegion('${r.id}')" class="px-3 py-1.5 text-xs font-black rounded-lg border-2 transition-all ${state.activeRegionId === r.id ? 'region-tab-active shadow-sm' : 'border-slate-100 text-slate-400 hover:border-slate-300'}">${r.name}</button>`).join('');
            document.getElementById('total-budget').innerText = numFmt.format(total) + "元";
            document.getElementById('avg-cost').innerText = numFmt.format(avg) + "元";
            document.getElementById('btn-method-wall').className = `flex-1 py-2 text-xs font-black rounded-lg transition-all ${isWall ? 'method-tab-active' : 'text-slate-400'}`;
            document.getElementById('btn-method-pile').className = `flex-1 py-2 text-xs font-black rounded-lg transition-all ${!isWall ? 'method-tab-active' : 'text-slate-400'}`;

            document.querySelectorAll('.input-group').forEach(el => {
                const k = el.dataset.key;
                el.innerHTML = `<label class="text-[9px] font-black uppercase text-slate-400 mb-1 block">${el.dataset.label}</label><div class="relative"><input type="number" value="${state[k] || (k==='belowPerimeter'?physics.sysPerimeter:'')}" onchange="updateState('${k}', this.value)" class="w-full border rounded-xl px-4 py-2 text-sm font-black outline-none focus:border-indigo-500 transition-all"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-300 font-black">${el.dataset.unit}</span></div>`;
            });

            document.querySelectorAll('.input-group-region').forEach(el => {
                const k = el.dataset.key; const reg = regions.find(r => r.id === state.activeRegionId);
                el.innerHTML = `<label class="text-[9px] font-black uppercase text-slate-400 mb-1 block">${el.dataset.label}</label><div class="relative"><input type="number" step="0.01" value="${reg[k]}" onchange="updateRegionParam('${k}', this.value)" class="w-full border rounded-xl px-3 py-2 text-xs font-black outline-none focus:border-indigo-500 transition-all"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-[9px] text-slate-300 font-black">${el.dataset.unit}</span></div>`;
            });

            const wallDetail = isWall 
                ? `壁厚:${Math.round(physics.wallThickness * 100)}cm / 壁深:${physics.wallDepth.toFixed(1)}m / 壁體面積:${Math.round(physics.wallTotalArea)}m²` 
                : `樁數:${physics.pileCount}支 / 面積:${Math.round(physics.wallTotalArea)}m²`;

            const cards = [
                { t: "擋土與開挖", v: `${physics.excavationDepth.toFixed(1)} m`, i: "arrow-down-to-line", sub: wallDetail },
                { t: "主體結構量", v: `${numFmt.format(physics.totalRC)} m³`, i: "droplet", sub: `模板:${numFmt.format(physics.totalForm)}m² / 鋼筋:${(physics.totalRebar/1000).toFixed(1)}T` },
                { t: "支撐與構台", v: `${physics.supportLayers} 層`, i: "layers", sub: `中間樁:${physics.supportPostCount}支 / 構台:${Math.round(physics.platformArea)}m²` },
                { t: "土方與規模", v: `${numFmt.format(physics.totalBelowBuildArea)} 坪`, i: "component", sub: `預估土方量: ${numFmt.format(physics.earthworkVolume)} m³` }
            ];

            document.getElementById('physics-cards').innerHTML = cards.map(c => `
                <div class="physics-card bg-white p-6 rounded-[32px] border border-slate-200 shadow-sm">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="bg-indigo-50 p-2 rounded-xl text-indigo-600"><i data-lucide="${c.i}" class="w-4 h-4"></i></div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${c.t}</span>
                    </div>
                    <div class="text-3xl font-black text-slate-800 leading-none mb-3">${c.v}</div>
                    <div class="text-[11px] font-bold text-slate-400 bg-slate-50 px-3 py-2 rounded-xl inline-block border border-slate-100">${c.sub}</div>
                </div>`).join('');

            document.getElementById('budget-body').innerHTML = results.map(r => `
                <tr class="hover:bg-indigo-50/50">
                    <td class="px-8 py-6"><div class="text-sm font-black text-slate-800">${r.l}</div><div class="w-full bg-slate-100 h-1 mt-2 rounded-full overflow-hidden"><div class="h-full ${r.color}" style="width: ${total>0?(r.v/total*100):0}%"></div></div></td>
                    <td class="px-8 py-6 text-right font-black text-slate-700">${numFmt.format(r.v)}元</td>
                </tr>`).join('');

            const reg = regions.find(r => r.id === state.activeRegionId);
            const wallKeys = isWall ? ['rateWall60','rateWall70','rateWall80','rateWall90','rateWall100','rateGuideWall','rateWallChip','rateWallRebarBend', 'depthRatio', 'thicknessRatio', 'ratePavement','rateSettlingTank'] : ['ratePileUnit','rateCappingBeam','rateLaggingBoard'];
            const supportKeys = ['supportHorizontalSpacing', 'supportVerticalSpan', 'platformRatio', 'rateSupportM2', 'rateSupportPostRent', 'rateSupportPostBuy', 'ratePlatformM2', 'rateMonitoring'];
            const otherKeys = ['rateEarthworkM3','rateRC_M3','ratePC_M3','rateForm_M2','rateRebar_KG','rateBasementMEP','rateBasementFinish'];

            const renderRates = (keys) => keys.map(k => `<div class="flex items-center justify-between group"><label class="text-[9px] font-black text-slate-500 group-hover:text-indigo-300 transition-colors">${KEY_LABELS[k]}</label><input type="number" step="0.1" value="${reg[k]}" onchange="updateRegionParam('${k}', this.value)" class="w-24 bg-slate-800 border-none rounded px-2 py-1 text-xs font-black text-white outline-none focus:ring-1 ring-indigo-500"></div>`).join('');

            document.getElementById('wall-rates-list').innerHTML = renderRates(wallKeys);
            document.getElementById('support-rates-list').innerHTML = renderRates(supportKeys);
            document.getElementById('other-rates-list').innerHTML = renderRates(otherKeys);
            document.getElementById('current-region-label').innerText = reg ? reg.name : "未選擇";
            lucide.createIcons();
        }

        window.onload = initFirebase;
    </script>
</body>
</html>